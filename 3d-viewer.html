<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Viewer - Sejarah Indonesia</title>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            color: white;
        }

        /* Canvas Container */
        #canvas-container {
            width: 70vw;
            height: 100vh;
            position: relative;
            float: left;
        }

        /* Side Panel */
        #side-panel {
            width: 30vw;
            height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            background: rgba(30, 30, 46, 0.98);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            padding: 90px 30px 30px 30px;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
            z-index: 999;
        }

        .panel-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .panel-era {
            display: inline-block;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            padding: 8px 18px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 10px;
            border-left: 3px solid #8b5cf6;
        }

        .info-icon {
            width: 35px;
            height: 35px;
            min-width: 35px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 12px;
        }

        .info-content {
            flex: 1;
        }

        .info-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #a0a0c0;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .info-value {
            font-size: 15px;
            color: white;
            font-weight: 600;
            line-height: 1.4;
        }

        .description-section {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid rgba(139, 92, 246, 0.3);
        }

        .description-title {
            font-size: 16px;
            font-weight: 700;
            color: #8b5cf6;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .description-text {
            font-size: 14px;
            color: #c0c0d0;
            line-height: 1.8;
            text-align: justify;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-progress {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Header */
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        #back-button {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateX(-5px);
        }

        #model-title {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            flex: 1;
        }

        .title-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        /* Controls Info */
        #controls-info {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90%;
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .control-icon {
            width: 35px;
            height: 35px;
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid rgba(139, 92, 246, 0.5);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .control-text {
            display: flex;
            flex-direction: column;
        }

        .control-label {
            font-weight: 600;
            font-size: 12px;
            opacity: 0.8;
        }

        .control-desc {
            font-weight: 700;
            font-size: 14px;
        }

        /* Reset Button */
        #reset-button {
            position: fixed;
            top: 90px;
            right: 20px;
            background: rgba(139, 92, 246, 0.9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        #reset-button:hover {
            background: rgba(139, 92, 246, 1);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.6);
        }

        /* Error Message */
        #error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(239, 68, 68, 0.95);
            color: white;
            padding: 30px 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 10000;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #error-message.show {
            display: block;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .error-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .error-desc {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #canvas-container {
                width: 100vw;
                height: 50vh;
                float: none;
            }

            #side-panel {
                width: 100vw;
                height: 50vh;
                position: fixed;
                bottom: 0;
                right: 0;
                top: auto;
                padding: 20px;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            }

            .panel-title {
                font-size: 20px;
            }

            .info-item {
                padding: 10px;
                margin-bottom: 10px;
            }

            .info-icon {
                width: 30px;
                height: 30px;
                min-width: 30px;
                font-size: 16px;
            }

            .info-value {
                font-size: 13px;
            }

            .description-text {
                font-size: 13px;
            }

            #header {
                padding: 15px;
            }

            #model-title {
                font-size: 16px;
            }

            .title-badge {
                font-size: 10px;
                padding: 3px 10px;
            }

            #controls-info {
                padding: 12px 20px;
                gap: 15px;
                bottom: 10px;
            }

            .control-item {
                font-size: 11px;
            }

            .control-icon {
                width: 30px;
                height: 30px;
                font-size: 16px;
            }

            #reset-button {
                top: auto;
                bottom: 100px;
                right: 15px;
                padding: 10px 20px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div class="loading-text">Memuat Model 3D...</div>
        <div class="loading-progress" id="loading-progress">0%</div>
    </div>

    <!-- Error Message -->
    <div id="error-message">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">Gagal Memuat Model</div>
        <div class="error-desc">Model 3D tidak ditemukan atau format tidak didukung.</div>
    </div>

    <!-- Header -->
    <div id="header">
        <a href="ar-viewer.html" id="back-button">
            <span>‚Üê</span>
            <span>Kembali</span>
        </a>
        <div id="model-title">
            <span id="model-name">Model 3D</span>
            <span class="title-badge">Interactive Viewer</span>
        </div>
        <div style="width: 100px;"></div> <!-- Spacer untuk center title -->
    </div>

    <!-- Reset Button -->
    <button id="reset-button" onclick="resetCamera()">üîÑ Reset View</button>

    <!-- Controls Info -->
    <div id="controls-info">
        <div class="control-item">
            <div class="control-icon">üñ±Ô∏è</div>
            <div class="control-text">
                <span class="control-label">Drag / Swipe</span>
                <span class="control-desc">Rotate</span>
            </div>
        </div>
        <div class="control-item">
            <div class="control-icon">üîç</div>
            <div class="control-text">
                <span class="control-label">Scroll / Pinch</span>
                <span class="control-desc">Zoom</span>
            </div>
        </div>
        <div class="control-item">
            <div class="control-icon">‚úã</div>
            <div class="control-text">
                <span class="control-label">Right Click</span>
                <span class="control-desc">Pan</span>
            </div>
        </div>
    </div>

    <!-- Canvas Container -->
    <div id="canvas-container"></div>

    <!-- Side Panel -->
    <div id="side-panel">
        <h1 class="panel-title" id="panel-title">Homo Erectus</h1>
        <span class="panel-era" id="panel-era">Pleistosen Tengah</span>

        <div class="info-section" id="info-section">
            <!-- Info items will be dynamically populated -->
        </div>

        <div class="description-section">
            <div class="description-title">
                üìñ Deskripsi Lengkap
            </div>
            <div class="description-text" id="description-text">
                Loading...
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const modelPath = urlParams.get('model');
        const modelName = urlParams.get('name') || 'Model 3D';
        const markerId = urlParams.get('marker');

        // Set model name in header
        document.getElementById('model-name').textContent = modelName;

        // Marker data (harus sama dengan ar-viewer.html)
        const markerDataDetail = {
            0: {
                name: "Prasasti Ciaruteun",
                type: "prasasti",
                era: "Kerajaan Tarumanegara",
                periode: "Abad ke-5 Masehi",
                lokasiPenemuan: "Kampung Muara, Desa Ciaruteun Hilir, Cibungbulang, Bogor, Jawa Barat",
                aksara: "Pallawa",
                bahasa: "Sanskerta",
                ciriKhas: "Memiliki relief sepasang telapak kaki yang melambangkan Raja Purnawarman dan disamakan dengan kaki Dewa Wisnu. Terdiri atas Inskripsi A dan Inskripsi B, di mana Inskripsi B belum terbaca pasti.",
                description: "Prasasti Ciaruteun merupakan bukti kekuasaan dan legitimasi Raja Purnawarman dari Kerajaan Tarumanegara melalui simbol keagamaan dan politik."
            },
            1: {
                name: "Kapak Genggam",
                type: "artefak",
                era: "Zaman Paleolitikum",
                periode: "2 juta - 200 ribu tahun lalu",
                teknik: "Teknik pukul-lepas (percussion flaking)",
                fungsi: "Memotong, mengolah makanan, menguliti hewan, dan memecah tulang",
                lokasiPenemuan: "Pacitan, Jawa Timur",
                pengguna: "Homo erectus",
                ciriKhas: "Digunakan tanpa tangkai, bermata tajam di dua sisi, dan terbuat dari batu keras",
                description: "Kapak genggam merupakan alat batu tertua yang mencerminkan awal perkembangan teknologi manusia purba."
            },
            2: {
                name: "Kapak Lonjong",
                type: "artefak",
                era: "Zaman Neolitikum",
                periode: "3000 - 1500 SM",
                teknik: "Teknik pengasahan hingga permukaan halus dan tajam",
                fungsi: "Alat pertanian, penebangan, serta benda ritual dan simbol status sosial",
                lokasiPenemuan: "Papua, Maluku, dan Sulawesi",
                ciriKhas: "Berbentuk lonjong, digunakan dengan tangkai, dan terbuat dari batu halus seperti nefrit",
                description: "Kapak lonjong menandai revolusi Neolitikum dengan peralihan dari berburu ke kehidupan menetap dan bercocok tanam."
            },
            3: {
                name: "Homo Erectus",
                type: "fossil",
                era: "Pleistosen Tengah",
                periode: "1,5 juta - 300 ribu tahun lalu",
                penemu: "Eugene Dubois",
                tahunPenemuan: "1891",
                lokasiPenemuan: "Trinil, Jawa Timur",
                tinggi: "160-170 cm",
                volumeOtak: "750-1.200 cc",
                ciri: "Dahi miring ke belakang, alis tebal dan menonjol",
                description: "Homo erectus merupakan jenis manusia purba yang ditemukan oleh Eugene Dubois pada tahun 1891 dan hidup sekitar 1,5 juta hingga 300 ribu tahun yang lalu. Manusia purba ini memiliki tinggi badan sekitar 160‚Äì170 cm dengan tubuh yang tegap dan sudah mampu berjalan tegak sepenuhnya. Volume otaknya berkisar antara 750 hingga 1.200 cc, dengan ciri dahi miring ke belakang dan alis yang tebal dan menonjol. Homo erectus telah mampu menggunakan alat batu sederhana, menguasai api untuk memasak dan perlindungan, serta hidup berkelompok. Mereka biasanya tinggal di gua atau daerah terbuka yang dekat dengan sumber air."
            },
            4: {
                name: "Meganthropus Paleojavanicus",
                type: "fossil",
                era: "Pleistosen Awal",
                periode: "1-2 juta tahun lalu",
                penemu: "G.H.R. von Koenigswald",
                tahunPenemuan: "1937‚Äì1941",
                lokasiPenemuan: "Sangiran, Jawa Tengah",
                tinggi: "Sekitar 2‚Äì2,5 meter",
                volumeOtak: "Sekitar ¬±900 cc",
                ciri: "Rahang sangat tebal, tidak berdagu, gigi geraham besar, wajah menonjol ke depan, dan otot kunyah sangat kuat",
                description: "Meganthropus paleojavanicus merupakan manusia purba tertua di Indonesia dengan ciri fisik yang masih sangat primitif."
            },
            5: {
                name: "Dolmen",
                type: "struktur",
                era: "Zaman Megalitikum",
                periode: "2000 SM - 500 M",
                lokasiPenemuan: "Bondowoso dan Puger (Jawa Timur), Pasemah (Sumatra Selatan), dan Sumba (Nusa Tenggara Timur)",
                fungsi: "Tempat sesaji arwah leluhur dan penutup kubur batu tokoh penting",
                ciriKhas: "Meja batu besar dengan batu penyangga, berasal dari tradisi megalitik dan menunjukkan stratifikasi sosial",
                description: "Dolmen menggambarkan kepercayaan masyarakat megalitik terhadap roh nenek moyang dan kehidupan setelah mati."
            }
        };

        // Populate side panel with marker data
        function populateSidePanel() {
            if (markerId && markerDataDetail[markerId]) {
                const data = markerDataDetail[markerId];
                
                // Set title and era
                document.getElementById('panel-title').textContent = data.name;
                document.getElementById('panel-era').textContent = data.era;
                
                // Build info items based on available data
                const infoSection = document.getElementById('info-section');
                infoSection.innerHTML = '';
                
                // Periode
                if (data.periode) {
                    infoSection.innerHTML += createInfoItem('‚è∞', 'Periode', data.periode);
                }
                
                // PRASASTI (Marker 0)
                if (data.type === 'prasasti') {
                    if (data.lokasiPenemuan) {
                        infoSection.innerHTML += createInfoItem('üìç', 'Lokasi', data.lokasiPenemuan);
                    }
                    if (data.aksara) {
                        infoSection.innerHTML += createInfoItem('‚úçÔ∏è', 'Aksara', data.aksara);
                    }
                    if (data.bahasa) {
                        infoSection.innerHTML += createInfoItem('üó£Ô∏è', 'Bahasa', data.bahasa);
                    }
                    if (data.ciriKhas) {
                        infoSection.innerHTML += createInfoItem('‚ú®', 'Ciri Khas', data.ciriKhas);
                    }
                }
                
                // ARTEFAK (Marker 1, 2)
                if (data.type === 'artefak') {
                    if (data.teknik) {
                        infoSection.innerHTML += createInfoItem('üî®', 'Teknik Pembuatan', data.teknik);
                    }
                    if (data.fungsi) {
                        infoSection.innerHTML += createInfoItem('‚öôÔ∏è', 'Fungsi', data.fungsi);
                    }
                    if (data.lokasiPenemuan) {
                        infoSection.innerHTML += createInfoItem('üìç', 'Lokasi Penemuan', data.lokasiPenemuan);
                    }
                    if (data.pengguna) {
                        infoSection.innerHTML += createInfoItem('üë§', 'Pengguna', data.pengguna);
                    }
                    if (data.ciriKhas) {
                        infoSection.innerHTML += createInfoItem('‚ú®', 'Ciri Khas', data.ciriKhas);
                    }
                }
                
                // FOSSIL (Marker 3, 4)
                if (data.type === 'fossil') {
                    if (data.tahunPenemuan) {
                        infoSection.innerHTML += createInfoItem('üìÖ', 'Tahun Penemuan', data.tahunPenemuan);
                    }
                    if (data.penemu) {
                        infoSection.innerHTML += createInfoItem('üë§', 'Penemu', data.penemu);
                    }
                    if (data.lokasiPenemuan) {
                        infoSection.innerHTML += createInfoItem('üìç', 'Lokasi Penemuan', data.lokasiPenemuan);
                    }
                    if (data.tinggi) {
                        infoSection.innerHTML += createInfoItem('üìè', 'Tinggi Badan', data.tinggi);
                    }
                    if (data.volumeOtak) {
                        infoSection.innerHTML += createInfoItem('üß†', 'Volume Otak', data.volumeOtak);
                    }
                    if (data.ciri) {
                        infoSection.innerHTML += createInfoItem('‚ú®', 'Ciri Khas', data.ciri);
                    }
                }
                
                // STRUKTUR (Marker 5, 6, 7)
                if (data.type === 'struktur') {
                    if (data.fungsi) {
                        infoSection.innerHTML += createInfoItem('‚öôÔ∏è', 'Fungsi', data.fungsi);
                    }
                    if (data.lokasiPenemuan) {
                        infoSection.innerHTML += createInfoItem('üìç', 'Lokasi', data.lokasiPenemuan);
                    }
                    if (data.ciriKhas) {
                        infoSection.innerHTML += createInfoItem('‚ú®', 'Ciri Khas', data.ciriKhas);
                    }
                }
                
                // Description
                document.getElementById('description-text').textContent = data.description;
            }
        }

        // Helper function to create info item HTML
        function createInfoItem(icon, label, value) {
            return `
                <div class="info-item">
                    <div class="info-icon">${icon}</div>
                    <div class="info-content">
                        <div class="info-label">${label}</div>
                        <div class="info-value">${value}</div>
                    </div>
                </div>
            `;
        }

        // Populate panel on load
        populateSidePanel();

        // Three.js variables
        let scene, camera, renderer, model, controls;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let rotation = { x: 0, y: 0 };
        let targetRotation = { x: 0, y: 0 };
        let cameraDistance = 5;
        let targetCameraDistance = 5;

        // Touch variables
        let touchStartDistance = 0;
        let lastTouchX = 0;
        let lastTouchY = 0;

        // Initialize
        init();
        animate();

        function init() {
            // Check if model path exists
            if (!modelPath) {
                showError();
                return;
            }

            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1e1e2e);

            // Create camera
            camera = new THREE.PerspectiveCamera(
                45,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 1.5, 5);
            camera.lookAt(0, 1, 0);

            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            const container = document.getElementById('canvas-container');
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight1.position.set(5, 5, 5);
            directionalLight1.castShadow = true;
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight2.position.set(-5, 3, -5);
            scene.add(directionalLight2);

            const pointLight = new THREE.PointLight(0x8b5cf6, 0.5, 10);
            pointLight.position.set(0, 3, 0);
            scene.add(pointLight);

            // Add grid helper (optional)
            const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
            gridHelper.position.y = -0.5;
            scene.add(gridHelper);

            // Load 3D model
            loadModel(modelPath);

            // Event listeners
            window.addEventListener('resize', onWindowResize);
            setupMouseControls();
            setupTouchControls();
        }

        function loadModel(path) {
            const loader = new THREE.GLTFLoader();
            
            loader.load(
                path,
                function(gltf) {
                    model = gltf.scene;
                    
                    // Center and scale model
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 2 / maxDim;
                    model.scale.multiplyScalar(scale);
                    
                    model.position.sub(center.multiplyScalar(scale));
                    model.position.y += 1;
                    
                    // Enable shadows
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    scene.add(model);
                    hideLoading();
                },
                function(xhr) {
                    const progress = (xhr.loaded / xhr.total * 100).toFixed(0);
                    document.getElementById('loading-progress').textContent = progress + '%';
                },
                function(error) {
                    console.error('Error loading model:', error);
                    showError();
                }
            );
        }

        function setupMouseControls() {
            const canvas = renderer.domElement;

            // Mouse down
            canvas.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // Left click only
                    isDragging = true;
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });

            // Mouse move
            canvas.addEventListener('mousemove', (e) => {
                if (isDragging && model) {
                    const deltaX = e.clientX - previousMousePosition.x;
                    const deltaY = e.clientY - previousMousePosition.y;
                    
                    targetRotation.y += deltaX * 0.01;
                    targetRotation.x += deltaY * 0.01;
                    
                    // Limit vertical rotation
                    targetRotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, targetRotation.x));
                    
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });

            // Mouse up
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
            });

            // Mouse wheel for zoom
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                targetCameraDistance += e.deltaY * 0.01;
                targetCameraDistance = Math.max(2, Math.min(15, targetCameraDistance));
            });
        }

        function setupTouchControls() {
            const canvas = renderer.domElement;

            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    // Single touch - rotate
                    lastTouchX = e.touches[0].clientX;
                    lastTouchY = e.touches[0].clientY;
                    isDragging = true;
                } else if (e.touches.length === 2) {
                    // Two touches - zoom
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    touchStartDistance = Math.sqrt(dx * dx + dy * dy);
                }
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                if (e.touches.length === 1 && isDragging && model) {
                    // Rotate
                    const deltaX = e.touches[0].clientX - lastTouchX;
                    const deltaY = e.touches[0].clientY - lastTouchY;
                    
                    targetRotation.y += deltaX * 0.01;
                    targetRotation.x += deltaY * 0.01;
                    targetRotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, targetRotation.x));
                    
                    lastTouchX = e.touches[0].clientX;
                    lastTouchY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    // Zoom
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    const delta = touchStartDistance - distance;
                    targetCameraDistance += delta * 0.01;
                    targetCameraDistance = Math.max(2, Math.min(15, targetCameraDistance));
                    
                    touchStartDistance = distance;
                }
            });

            canvas.addEventListener('touchend', () => {
                isDragging = false;
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            if (model) {
                // Smooth rotation
                rotation.x += (targetRotation.x - rotation.x) * 0.1;
                rotation.y += (targetRotation.y - rotation.y) * 0.1;
                
                model.rotation.x = rotation.x;
                model.rotation.y = rotation.y;
            }

            // Smooth zoom
            cameraDistance += (targetCameraDistance - cameraDistance) * 0.1;
            camera.position.z = cameraDistance;

            renderer.render(scene, camera);
        }

        function resetCamera() {
            targetRotation = { x: 0, y: 0 };
            targetCameraDistance = 5;
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function hideLoading() {
            const loading = document.getElementById('loading-screen');
            loading.classList.add('hidden');
        }

        function showError() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('error-message').classList.add('show');
        }

        // Debug: Log model path
        console.log('Loading model from:', modelPath);
    </script>
</body>
</html>
