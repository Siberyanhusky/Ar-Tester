<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Marker - Candi Borobudur</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(139,69,19,0.95) 0%, rgba(139,69,19,0.7) 100%);
            padding: 15px;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        .header h1 {
            color: #FFD700;
            font-size: 18px;
            text-align: center;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
        
        .header p {
            color: #FFF;
            font-size: 11px;
            text-align: center;
            margin: 5px 0 0 0;
        }
        
        .info-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(139,69,19,0.95);
            border-radius: 15px;
            padding: 20px;
            color: white;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            max-height: 40vh;
            overflow-y: auto;
            border: 2px solid #FFD700;
        }
        
        .info-panel h2 {
            color: #FFD700;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .info-panel h3 {
            color: #FFD700;
            font-size: 13px;
            margin-top: 12px;
            margin-bottom: 6px;
        }
        
        .info-panel p {
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .info-panel ul {
            margin-left: 18px;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .fact-box {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 3px solid #FFD700;
        }
        
        .controls {
            position: fixed;
            top: 90px;
            right: 20px;
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 10000;
        }
        
        .close-btn {
            position: fixed;
            top: 90px;
            left: 20px;
            background: rgba(220, 20, 60, 0.95);
            border: 2px solid #FFD700;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .close-btn:active {
            transform: scale(0.95);
        }
        
        .scan-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(34, 139, 34, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            z-index: 15000;
            display: none;
            text-align: center;
            border: 3px solid #FFD700;
            box-shadow: 0 8px 30px rgba(0,0,0,0.8);
        }
        
        .control-btn {
            background: rgba(139,69,19,0.95);
            border: 2px solid #FFD700;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: #FFD700;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        .instruction {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139,69,19,0.98);
            color: white;
            padding: 25px;
            border-radius: 15px;
            z-index: 20000;
            text-align: center;
            border: 3px solid #FFD700;
            max-width: 85%;
            box-shadow: 0 8px 30px rgba(0,0,0,0.8);
        }
        
        .instruction h2 {
            color: #FFD700;
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        .instruction p {
            font-size: 14px;
            line-height: 1.8;
            margin: 12px 0;
        }
        
        .instruction button {
            margin-top: 20px;
            background: #FFD700;
            color: #8B4513;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            -webkit-appearance: button;
            -moz-appearance: button;
            appearance: button;
        }
        
        .instruction button:active {
            transform: scale(0.95);
        }
        
        .marker-image {
            width: 150px;
            height: 150px;
            background: white;
            border: 3px solid #FFD700;
            border-radius: 10px;
            margin: 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #8B4513;
            padding: 10px;
        }
        
        .download-marker {
            display: inline-block;
            background: #FFD700;
            color: #8B4513;
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            margin-top: 10px;
            font-weight: bold;
            font-size: 14px;
        }
        
        #arjs-video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
        }
        
        a-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è AR MARKER - CANDI BOROBUDUR</h1>
        <p id="headerStatus">Arahkan kamera ke marker untuk melihat model 3D</p>
    </div>
    
    <div class="scan-status" id="scanStatus">
        ‚úÖ CANDI BERHASIL DI-SCAN!<br>
        <span style="font-size: 14px;">Model akan tetap muncul</span>
    </div>
    
    <button class="close-btn" id="closeBtn" onclick="closeModel()">‚úï</button>
    
    <div class="instruction" id="instruction">
        <h2>üì± Cara Menggunakan AR Marker</h2>
        <p><strong>1. Download & Print Marker</strong></p>
        <div class="marker-image">
            üìÑ Marker Hiro<br>
            (akan muncul setelah klik "Mulai")
        </div>
        <p><strong>2. Izinkan Akses Kamera</strong></p>
        <p>Klik "Mulai AR" lalu izinkan akses kamera</p>
        <p><strong>3. Arahkan ke Marker</strong></p>
        <p>Scan marker yang sudah di-print, model Candi Borobudur akan muncul!</p>
        <p style="font-size: 11px; color: #FFD700; margin-top: 15px;">
            üí° Tip: Pastikan marker terlihat jelas di kamera dan ruangan cukup terang
        </p>
        <button onclick="startAR()">Mulai AR</button>
        <br>
        <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" download class="download-marker" target="_blank">
            ‚¨áÔ∏è Download Marker
        </a>
    </div>
    
    <div class="controls" id="controls" style="display: none;">
        <button class="control-btn" onclick="toggleInfo()" title="Info">üìñ</button>
        <button class="control-btn" onclick="showMarkerHelp()" title="Help">‚ùì</button>
    </div>
    
    <div class="info-panel" id="infoPanel" style="display: none;">
        <h2>üèõÔ∏è Candi Borobudur</h2>
        
        <div class="fact-box">
            <h3>üìÖ Periode Pembangunan</h3>
            <p>Dibangun sekitar tahun 780-840 Masehi pada masa Dinasti Syailendra di Kerajaan Mataram Kuno.</p>
        </div>
        
        <div class="fact-box">
            <h3>üëë Dinasti Syailendra</h3>
            <p>Dinasti yang menguasai Jawa Tengah dan dikenal sebagai pelindung agama Buddha.</p>
        </div>
        
        <div class="fact-box">
            <h3>üèóÔ∏è Arsitektur 9 Tingkat</h3>
            <ul>
                <li><strong>Kamadhatu:</strong> Tingkat dasar (dunia nafsu)</li>
                <li><strong>Rupadhatu:</strong> Tingkat tengah (dunia bentuk)</li>
                <li><strong>Arupadhatu:</strong> Tingkat atas (dunia tanpa bentuk)</li>
            </ul>
        </div>
        
        <div class="fact-box">
            <h3>üé® Relief & Stupa</h3>
            <ul>
                <li>2.672 panel relief cerita Buddha</li>
                <li>504 arca Buddha</li>
                <li>72 stupa berlubang</li>
                <li>1 stupa utama (35 meter)</li>
            </ul>
        </div>
        
        <div class="fact-box">
            <h3>üìç Status</h3>
            <p><strong>Lokasi:</strong> Magelang, Jawa Tengah</p>
            <p><strong>UNESCO:</strong> Situs Warisan Dunia sejak 1991</p>
        </div>
        
        <div class="fact-box">
            <h3>üîç Fakta Menarik</h3>
            <ul>
                <li>Sistem interlock tanpa semen</li>
                <li>Ditemukan Raffles (1814)</li>
                <li>Sempat terkubur abu vulkanik</li>
                <li>Dipugar UNESCO (1975-1982)</li>
            </ul>
        </div>
    </div>

    <!-- A-Frame Scene -->
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        id="arScene"
        style="display: none;">
        
        <!-- Camera -->
        <a-entity camera></a-entity>
        
        <!-- Marker -->
        <a-marker preset="hiro" id="marker" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" raycaster="objects: .clickable">
            <!-- Container untuk model 3D kita -->
            <a-entity id="candiContainer" position="0 0.5 0" scale="0.8 0.8 0.8" visible="true">
                <!-- Model 3D akan ditambahkan via JavaScript -->
            </a-entity>
        </a-marker>
    </a-scene>

    <script>
        let markerDetected = false;
        let arStarted = false;
        let currentScale = 0.8;
        let currentRotation = 0;
        let candiContainer = null;
        let modelScanned = false;
        let markerElement = null;
        
        // Pastikan library loaded
        window.addEventListener('load', function() {
            console.log('Page loaded');
            setTimeout(() => {
                const instruction = document.getElementById('instruction');
                if (instruction) {
                    instruction.style.display = 'block';
                }
            }, 500);
        });
        
        function startAR() {
            console.log('Starting AR...');
            
            if (arStarted) {
                console.log('AR already started');
                return;
            }
            
            arStarted = true;
            
            const instruction = document.getElementById('instruction');
            const arScene = document.getElementById('arScene');
            
            if (instruction) instruction.style.display = 'none';
            if (arScene) arScene.style.display = 'block';
            
            setTimeout(() => {
                createCandiBorobudur();
                setupMarkerEvents();
            }, 1500);
        }
        
        function setupMarkerEvents() {
            markerElement = document.querySelector('#marker');
            candiContainer = document.querySelector('#candiContainer');
            
            if (!markerElement) {
                console.error('Marker element not found');
                return;
            }
            
            markerElement.addEventListener('markerFound', () => {
                console.log('Marker ditemukan!');
                markerDetected = true;
                
                // Make sure container is visible
                if (candiContainer) {
                    candiContainer.setAttribute('visible', 'true');
                }
                
                if (!modelScanned) {
                    modelScanned = true;
                    onFirstScan();
                }
            });
            
            markerElement.addEventListener('markerLost', () => {
                console.log('Marker hilang - MODEL TETAP MUNCUL!');
                markerDetected = false;
                
                // CRITICAL: Keep model visible even when marker is lost
                if (candiContainer) {
                    candiContainer.setAttribute('visible', 'true');
                }
            });
        }
        
        function onFirstScan() {
            console.log('First scan detected!');
            
            // Show success message
            const scanStatus = document.getElementById('scanStatus');
            if (scanStatus) {
                scanStatus.style.display = 'block';
                setTimeout(() => {
                    scanStatus.style.display = 'none';
                }, 3000);
            }
            
            // Update header
            const headerStatus = document.getElementById('headerStatus');
            if (headerStatus) {
                headerStatus.textContent = '‚úÖ Model berhasil dimuat - Marker bisa dilepas';
            }
            
            // Show controls and close button
            const controls = document.getElementById('controls');
            const closeBtn = document.getElementById('closeBtn');
            if (controls) controls.style.display = 'flex';
            if (closeBtn) closeBtn.style.display = 'flex';
            
            // PENTING: Show info panel automatically after 2 seconds
            setTimeout(() => {
                const infoPanel = document.getElementById('infoPanel');
                if (infoPanel) {
                    infoPanel.style.display = 'block';
                    console.log('Info panel displayed!');
                }
            }, 2000);
            
            // Keep checking visibility every frame
            const keepVisible = setInterval(() => {
                if (candiContainer && modelScanned) {
                    candiContainer.setAttribute('visible', 'true');
                } else {
                    clearInterval(keepVisible);
                }
            }, 100);
        }
        
        function closeModel() {
            console.log('Closing model...');
            
            // Reset container reference
            candiContainer = document.querySelector('#candiContainer');
            
            // Hide model
            if (candiContainer) {
                candiContainer.setAttribute('visible', 'false');
            }
            
            // Hide all UI
            const controls = document.getElementById('controls');
            const closeBtn = document.getElementById('closeBtn');
            const infoPanel = document.getElementById('infoPanel');
            
            if (controls) controls.style.display = 'none';
            if (closeBtn) closeBtn.style.display = 'none';
            if (infoPanel) infoPanel.style.display = 'none';
            
            // Reset state
            modelScanned = false;
            currentScale = 0.8;
            currentRotation = 0;
            
            // Update header
            const headerStatus = document.getElementById('headerStatus');
            if (headerStatus) {
                headerStatus.textContent = 'Arahkan kamera ke marker untuk melihat model 3D';
            }
            
            console.log('Model closed. Ready for re-scan.');
        }
        
        function scaleUp() {
            if (!candiContainer) candiContainer = document.querySelector('#candiContainer');
            if (candiContainer) {
                currentScale = Math.min(currentScale + 0.1, 2.0);
                candiContainer.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
                console.log('Scale up:', currentScale);
            }
        }
        
        function scaleDown() {
            if (!candiContainer) candiContainer = document.querySelector('#candiContainer');
            if (candiContainer) {
                currentScale = Math.max(currentScale - 0.1, 0.3);
                candiContainer.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
                console.log('Scale down:', currentScale);
            }
        }
        
        function rotateModel() {
            if (!candiContainer) candiContainer = document.querySelector('#candiContainer');
            if (candiContainer) {
                currentRotation += 45;
                if (currentRotation >= 360) currentRotation = 0;
                candiContainer.setAttribute('rotation', `0 ${currentRotation} 0`);
                console.log('Rotate:', currentRotation);
            }
        }
        
        function setupMarkerEvents() {
            const marker = document.querySelector('#marker');
            
            marker.addEventListener('markerFound', () => {
                markerDetected = true;
                console.log('Marker ditemukan!');
            });
            
            marker.addEventListener('markerLost', () => {
                markerDetected = false;
                console.log('Marker hilang!');
            });
        }
        
        function createCandiBorobudur() {
            const container = document.querySelector('#candiContainer');
            const scene = document.querySelector('a-scene');
            
            // Create base levels
            for (let i = 0; i < 2; i++) {
                const size = 3 - i * 0.3;
                const box = document.createElement('a-box');
                box.setAttribute('width', size);
                box.setAttribute('height', 0.2);
                box.setAttribute('depth', size);
                box.setAttribute('position', `0 ${i * 0.2} 0`);
                box.setAttribute('color', i === 0 ? '#5C4033' : '#8B7355');
                container.appendChild(box);
            }
            
            // Middle square levels
            for (let i = 0; i < 5; i++) {
                const size = 2.5 - i * 0.35;
                const box = document.createElement('a-box');
                box.setAttribute('width', size);
                box.setAttribute('height', 0.4);
                box.setAttribute('depth', size);
                box.setAttribute('position', `0 ${0.4 + i * 0.45} 0`);
                box.setAttribute('color', '#8B7355');
                container.appendChild(box);
                
                // Add small stupas
                const numStupas = 8 - i;
                for (let j = 0; j < numStupas; j++) {
                    const angle = (j / numStupas) * Math.PI * 2;
                    const radius = size * 0.35;
                    const stupa = document.createElement('a-cylinder');
                    stupa.setAttribute('radius', 0.08);
                    stupa.setAttribute('height', 0.2);
                    stupa.setAttribute('position', `${Math.cos(angle) * radius} ${0.4 + i * 0.45 + 0.3} ${Math.sin(angle) * radius}`);
                    stupa.setAttribute('color', '#A0826D');
                    container.appendChild(stupa);
                }
            }
            
            // Top circular levels
            for (let i = 0; i < 3; i++) {
                const radius = 0.9 - i * 0.25;
                const cylinder = document.createElement('a-cylinder');
                cylinder.setAttribute('radius', radius);
                cylinder.setAttribute('height', 0.15);
                cylinder.setAttribute('position', `0 ${2.6 + i * 0.25} 0`);
                cylinder.setAttribute('color', '#8B7355');
                container.appendChild(cylinder);
                
                // Add perforated stupas
                const numStupas = (3 - i) * 6;
                for (let j = 0; j < numStupas; j++) {
                    const angle = (j / numStupas) * Math.PI * 2;
                    const r = radius * 0.6;
                    const stupa = document.createElement('a-cylinder');
                    stupa.setAttribute('radius', 0.06);
                    stupa.setAttribute('height', 0.18);
                    stupa.setAttribute('position', `${Math.cos(angle) * r} ${2.6 + i * 0.25 + 0.15} ${Math.sin(angle) * r}`);
                    stupa.setAttribute('color', '#A0826D');
                    container.appendChild(stupa);
                }
            }
            
            // Main central stupa
            const mainStupa = document.createElement('a-cylinder');
            mainStupa.setAttribute('radius-top', 0.3);
            mainStupa.setAttribute('radius-bottom', 0.4);
            mainStupa.setAttribute('height', 0.6);
            mainStupa.setAttribute('position', '0 3.6 0');
            mainStupa.setAttribute('color', '#9B8B7E');
            container.appendChild(mainStupa);
            
            // Top sphere
            const top = document.createElement('a-sphere');
            top.setAttribute('radius', 0.2);
            top.setAttribute('position', '0 4.0 0');
            top.setAttribute('color', '#B8A892');
            container.appendChild(top);
            
            // Add rotation animation - REMOVED for stability
            // container.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear');
            
            // Save reference
            candiContainer = container;
        }
        
        function toggleInfo() {
            const panel = document.getElementById('infoPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function showMarkerHelp() {
            alert('üí° TIPS MENGGUNAKAN MARKER:\n\n1. Pastikan marker terlihat jelas di kamera\n2. Jaga jarak 20-50 cm dari marker\n3. Ruangan harus cukup terang\n4. Jangan tutup sebagian marker\n5. Marker harus rata (tidak bengkok)\n\nüì• Download marker di: https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png');
        }
    </script>
</body>
</html>
